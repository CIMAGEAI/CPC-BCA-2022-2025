{% extends "Admin/AdminMaster.html" %}

{% block title %}Modify Student | Admin Panel{% endblock %}

{% block head %}
<style>
    input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
    }

    .form-floating {
        margin-bottom: 1rem;
    }

    select.form-select {
        background-color: #000;
        color: white;
        appearance: auto !important;
    }
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Store the original values when page loads
    let originalRoll = $('#roll').val();
    let originalClass = $('#class').val();
    let originalSection = $('#section').val();
    let isNewStudent = !originalRoll; // Flag to check if this is a new student

    function validateNumber(event) {
        const keyCode = event.keyCode || event.which;
        const keyValue = String.fromCharCode(keyCode);

        if (/[0-9]/.test(keyValue) ||
            keyCode === 8 || keyCode === 46 ||
            keyCode === 9 || keyCode === 27 ||
            keyCode === 13) {
            return true;
        }

        event.preventDefault();
        return false;
    }
    
    async function getNextRoll(classVal, sectionVal, forceFetch = false) {
        if (!classVal || !sectionVal) {
            $('#roll').val('');
            return;
        }
        
        // If not forced and we're back to original class/section, restore original roll
        if (!forceFetch && originalRoll && classVal === originalClass && sectionVal === originalSection) {
            $('#roll').val(originalRoll);
            return;
        }
        
        try {
            const response = await fetch(`/admin/get-next-roll/${classVal}/${sectionVal}`);
            const data = await response.json();
            
            if (data.next_roll) {
                $('#roll').val(data.next_roll);
            }
        } catch (error) {
            console.error('Error fetching next roll number:', error);
        }
    }

    $(document).ready(function () {
        // Bus facility toggle
        $('#bus_facility').change(function () {
            if ($(this).val() === 'Yes') {
                $('.bus_fields').show();
            } else {
                $('.bus_fields').hide();
            }
        }).trigger('change');

        // Get bus routes when bus number changes
        $('#bus_number').change(function () {
            const busNumber = $(this).val();
            if (busNumber) {
                $.get('/admin/get-bus-routes/' + busNumber, function (data) {
                    $('#bus_route').empty().append('<option value="">--Select Bus Route--</option>');
                    data.routes.forEach(function (route) {
                        $('#bus_route').append($('<option>', {
                            value: route,
                            text: route
                        }));
                    });
                });
            }
        });

        // Get bus fee when route changes
        $('#bus_route').change(function () {
            const busNumber = $('#bus_number').val();
            const route = $(this).val();
            if (busNumber && route) {
                $.get('/admin/get-bus-fee/' + busNumber + '/' + route, function (data) {
                    $('#bus_fee').val(data.fee);
                });
            }
        });

        // Auto-generate roll number when class/section changes
        $('#class, #section').change(function () {
            const classVal = $('#class').val();
            const sectionVal = $('#section').val();
            if (classVal && sectionVal) {
                // Only fetch next roll if:
                // - It's a new student (no original roll)
                // - OR the class/section has changed from original
                const shouldFetch = isNewStudent || 
                                 (classVal !== originalClass || sectionVal !== originalSection);
                
                getNextRoll(classVal, sectionVal, shouldFetch);
            }
        });
        
        // For new students, fetch next roll if class/section is already selected
        if (isNewStudent && $('#class').val() && $('#section').val()) {
            getNextRoll($('#class').val(), $('#section').val(), true);
        }
    });
</script>
{% endblock %}

{% block content %}
<div class="container-fluid pt-4 px-4">
    <div class="row g-4">
        <div class="col-sm-12 col-xl-12">
            <div class="bg-secondary rounded h-100 p-4">
                <h5 class="mb-4">Modify Student's Details</h5>
                <form method="POST" enctype="multipart/form-data">
                    <h6 class="mb-4">Personal Info</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="std_id" name="std_id"
                                    placeholder="Student Id" value="{{ student.Student_ID }}" readonly
                                    style="background-color: #000;">
                                <label for="std_id">Student Id</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="name" name="name" placeholder="Student Name"
                                    value="{{ student.Name }}" required>
                                <label for="name">Student Name</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="mobile" name="mobile" placeholder="Mobile"
                                    value="{{ student.Mobile }}" maxlength="10"
                                    onkeypress="return validateNumber(event)" required>
                                <small class="text-danger" id="mobile_error"></small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <input type="email" class="form-control" id="email" name="email"
                                    placeholder="name@example.com" value="{{ student.Email }}">
                                <label for="email">Email</label>
                                <small class="text-danger" id="email_error"></small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="blood_group" name="blood_group"
                                    placeholder="Blood Group" value="{{ student.Blood }}">
                                <label for="blood_group">Blood Group</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="adhar" name="adhar"
                                    placeholder="Adhar Number" value="{{ student.Adhar }}" maxlength="12"
                                    onkeypress="return validateNumber(event)">
                                <label for="adhar">Adhar Number</label>
                                <small class="text-danger" id="adhar_error"></small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="gender" name="gender" required>
                                    <option value="">--Select Gender--</option>
                                    {% for gender in genders %}
                                    <option value="{{ gender }}" {% if student.Gender==gender %}selected{% endif %}>{{
                                        gender }}</option>
                                    {% endfor %}
                                </select>
                                <label for="gender">Gender</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="nationality" name="nationality" required>
                                    <option value="">--Select Nationality--</option>
                                    {% for nationality in nationalities %}
                                    <option value="{{ nationality }}" {% if student.Nationality==nationality
                                        %}selected{% endif %}>{{ nationality }}</option>
                                    {% endfor %}
                                </select>
                                <label for="nationality">Nationality</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="religion" name="religion" required>
                                    <option value="">--Select Religion--</option>
                                    {% for religion in religions %}
                                    <option value="{{ religion }}" {% if student.Religion==religion %}selected{% endif
                                        %}>{{ religion }}</option>
                                    {% endfor %}
                                </select>
                                <label for="religion">Religion</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="caste" name="caste"
                                    placeholder="Student Caste" value="{{ student.Caste }}">
                                <label for="caste">Student Caste</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="category" name="category" required>
                                    <option value="">--Select Category--</option>
                                    {% for category in categories %}
                                    <option value="{{ category }}" {% if student.Category==category %}selected{% endif
                                        %}>{{ category }}</option>
                                    {% endfor %}
                                </select>
                                <label for="category">Category</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <input type="date" class="form-control" id="dob" name="dob" value="{{ student.Dob }}">
                                <label for="dob">Date Of Birth</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <input type="date" class="form-control" id="admission_date" name="admission_date"
                                    value="{{ student.AdmissionDate }}">
                                <label for="admission_date">Date Of Admission</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="class" name="class" required>
                                    <option value="">--Select Class--</option>
                                    {% for class in classes %}
                                    <option value="{{ class }}" {% if student.Class==class %}selected{% endif %}>{{
                                        class }}</option>
                                    {% endfor %}
                                </select>
                                <label for="class">Class Name</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="section" name="section" required>
                                    <option value="">--Select Section--</option>
                                    {% for section in sections %}
                                    <option value="{{ section }}" {% if student.Section==section %}selected{% endif %}>
                                        {{ section }}</option>
                                    {% endfor %}
                                </select>
                                <label for="section">Section</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="roll" name="roll" placeholder="Roll Number"
                                    value="{{ student.Roll }}" readonly style="background-color: #000;">
                                <label for="roll">Roll Number</label>
                            </div>
                        </div>
                    </div>

                    <h6 class="mb-2 mt-4">Temporary Address</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="t_location" name="t_location"
                                    placeholder="Location" value="{{ student.TLocation }}">
                                <label for="t_location">Location</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="t_city" name="t_city" placeholder="City"
                                    value="{{ student.TCity }}">
                                <label for="t_city">City</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="t_pin" name="t_pin" placeholder="Pin Code"
                                    value="{{ student.TPin }}" maxlength="6" onkeypress="return validateNumber(event)">
                                <label for="t_pin">Pin Code</label>
                                <small class="text-danger" id="t_pin_error"></small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="t_state" name="t_state" placeholder="State"
                                    value="{{ student.TState }}">
                                <label for="t_state">State</label>
                            </div>
                        </div>
                    </div>

                    <h6 class="mb-2 mt-4">Permanent Address</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="p_location" name="p_location"
                                    placeholder="Location" value="{{ student.PLocation }}">
                                <label for="p_location">Location</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="p_city" name="p_city" placeholder="City"
                                    value="{{ student.PCity }}">
                                <label for="p_city">City</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="p_pin" name="p_pin" placeholder="Pin Code"
                                    value="{{ student.PPin }}" maxlength="6" onkeypress="return validateNumber(event)">
                                <label for="p_pin">Pin Code</label>
                                <small class="text-danger" id="p_pin_error"></small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="p_state" name="p_state" placeholder="State"
                                    value="{{ student.PState }}">
                                <label for="p_state">State</label>
                            </div>
                        </div>
                    </div>

                    <h6 class="mt-4 mb-2">Parent's Details</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="father_name" name="father_name"
                                    placeholder="Father Name" value="{{ student.FatherName }}">
                                <label for="father_name">Father's Name</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="father_mobile" name="father_mobile"
                                    placeholder="Father's Contact Number" value="{{ student.FatherMobile }}"
                                    maxlength="10" onkeypress="return validateNumber(event)">
                                <label for="father_mobile">Father's Contact Number</label>
                                <small class="text-danger" id="father_mobile_error"></small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="father_qualification"
                                    name="father_qualification" placeholder="Father's Qualification"
                                    value="{{ student.FatherQualification }}">
                                <label for="father_qualification">Father's Qualification</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="father_occupation" name="father_occupation"
                                    placeholder="Father's Occupation" value="{{ student.FatherOccupation }}">
                                <label for="father_occupation">Father's Occupation</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="father_annual" name="father_annual"
                                    placeholder="Father's Annual Income" value="{{ student.FatherAnnual }}">
                                <label for="father_annual">Father's Annual Income</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="mother_name" name="mother_name"
                                    placeholder="Mother Name" value="{{ student.MotherName }}">
                                <label for="mother_name">Mother's Name</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="mother_mobile" name="mother_mobile"
                                    placeholder="Mother's Contact Number" value="{{ student.MotherMobile }}"
                                    maxlength="10" onkeypress="return validateNumber(event)">
                                <label for="mother_mobile">Mother's Contact Number</label>
                                <small class="text-danger" id="mother_mobile_error"></small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="mother_qualification"
                                    name="mother_qualification" placeholder="Mother's Qualification"
                                    value="{{ student.MotherQualification }}">
                                <label for="mother_qualification">Mother's Qualification</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="mother_occupation" name="mother_occupation"
                                    placeholder="Mother's Occupation" value="{{ student.MotherOccupation }}">
                                <label for="mother_occupation">Mother's Occupation</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="mother_annual" name="mother_annual"
                                    placeholder="Mother's Annual Income" value="{{ student.MotherAnnual }}">
                                <label for="mother_annual">Mother's Annual Income</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="guardian" name="guardian"
                                    placeholder="Local Guardian Name" value="{{ student.Guardian }}">
                                <label for="guardian">Local Guardian Name</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="relationship" name="relationship"
                                    placeholder="Guardian RelationShip" value="{{ student.Relationship }}">
                                <label for="relationship">Guardian RelationShip</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="guardian_mobile" name="guardian_mobile"
                                    placeholder="Guardian Mobile Number" value="{{ student.GaurdianMobile }}"
                                    maxlength="10" onkeypress="return validateNumber(event)">
                                <label for="guardian_mobile">Guardian Mobile Number</label>
                                <small class="text-danger" id="guardian_mobile_error"></small>
                            </div>
                        </div>
                    </div>

                    <h6 class="mt-4 mb-2">Other Details</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="bus_facility" name="bus_facility">
                                    <option value="">--Select Bus Facility--</option>
                                    {% for facility in bus_facilities %}
                                    <option value="{{ facility }}" {% if student.BusFacility==facility %}selected{%
                                        endif %}>{{ facility }}</option>
                                    {% endfor %}
                                </select>
                                <label for="bus_facility">Bus Facility</label>
                            </div>
                        </div>

                        <div class="col-md-4 bus_fields" style="display: none;">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="bus_number" name="bus_number">
                                    <option value="">--Select Bus Number--</option>
                                    {% for number in bus_numbers %}
                                    <option value="{{ number }}" {% if student.BusNumber==number %}selected{% endif %}>
                                        {{ number }}</option>
                                    {% endfor %}
                                </select>
                                <label for="bus_number">Bus Number</label>
                            </div>
                        </div>
                        <div class="col-md-4 bus_fields" style="display: none;">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="bus_route" name="bus_route">
                                    <option value="">--Select Bus Route--</option>
                                    {% for route in bus_routes %}
                                    <option value="{{ route }}" {% if student.BusRoute==route %}selected{% endif %}>{{
                                        route }}</option>
                                    {% endfor %}
                                </select>
                                <label for="bus_route">Bus Route</label>
                            </div>
                        </div>
                        <div class="col-md-4 bus_fields" style="display: none;">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="bus_fee" name="bus_fee"
                                    placeholder="Bus Fee" value="{{ student.BusFee }}" readonly
                                    style="background-color: #000;">
                                <label for="bus_fee">Bus Fee</label>
                            </div>
                        </div>
                    </div>

                    <h6 class="mt-4 mb-2">Documents</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label for="dob_certificate">D.O.B Certificate</label>
                                <input type="file" class="form-control" id="dob_certificate" name="dob_certificate"
                                    style="background-color: #000;">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label for="leaving_certificate">Leaving Certificate</label>
                                <input type="file" class="form-control" id="leaving_certificate"
                                    name="leaving_certificate" style="background-color: #000;">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label for="last_qual_certificate">Last Qualification Proof</label>
                                <input type="file" class="form-control" id="last_qual_certificate"
                                    name="last_qual_certificate" style="background-color: #000;">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label for="student_image">Student Image</label>
                                <input type="file" class="form-control" id="student_image" name="student_image"
                                    style="background-color: #000;">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label for="adhar_image">Adhar Image</label>
                                <input type="file" class="form-control" id="adhar_image" name="adhar_image"
                                    style="background-color: #000;">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group mb-3">
                                <button type="submit" class="btn btn-primary w-100">Modify Details</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}