{% extends "Admin/AdminMaster.html" %}
{% block title %}Generate Monthly Fee{% endblock %}

{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="container mt-2">
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<div class="container-fluid pt-4 px-4">
    <div class="row g-4">
        <div class="col-sm-12 col-xl-12">
            <div class="bg-secondary rounded h-100 p-4">
                <h6 class="mb-4">Generate Fee</h6>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="txtsid" placeholder="Student ID">
                            <label for="txtsid">Student ID</label>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="mb-3" style="background-color: white; padding: 4px; border-radius: 5px; color: black;">
                            <label for="ddlmonth">Select Month</label>
                            <div id="monthCheckboxes" class="checkbox-container" style="display: none;">
                                <!-- Months will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group mb-3">
                            <button type="button" class="btn btn-primary w-100" id="BtnSave">Generate Bill</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid pt-4 px-4" id="feesstructure" style="display: none;">
    <div class="row g-4">
        <div class="col-sm-12 col-xl-12">
            <div class="bg-secondary rounded h-100 p-4">
                <h6 class="mb-4">Fees Structure</h6>
                <div class="row">
                    <div class="col-12">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered custom-grid-bg" id="studentInfoTable">
                                <thead class="thead-dark">
                                    <tr class="bg-primary text-white">
                                        <th>S.No.</th>
                                        <th>Student ID</th>
                                        <th>Name</th>
                                        <th>Class</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Student info will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="row">
                            <div class="col-sm-10"></div>
                            <div class="col-sm-2">
                                <button type="button" class="btn btn-primary" id="btnOpenModal">Edit</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered custom-grid-bg" id="feeSelectionTable">
                                <thead class="thead-dark">
                                    <tr class="bg-primary text-white">
                                        <th>S.No.</th>
                                        <th>Fee Name</th>
                                        <th>Months</th>
                                        <th>Fee Amount</th>
                                        <th>Select Fee</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Fees will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid pt-4 px-4">
    <div class="row g-4">
        <div class="col-sm-12 col-xl-12">
            <div class="bg-secondary rounded h-100 p-4">
                <h6 class="mb-4">Fees Calculation</h6>
                <form id="feeCalculationForm">
                    <input type="hidden" name="selected_fees" id="selectedFeesInput">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <label for="amount">Amount</label>
                            <input type="text" class="form-control bg-dark" id="amount" name="amount" value="0"
                                readonly>
                        </div>
                        <div class="col-md-3 mb-2">
                            <label for="previous_dues">Previous Dues Amount</label>
                            <input type="text" class="form-control bg-dark" id="previous_dues" name="previous_dues"
                                value="0" readonly>
                        </div>
                        <div class="col-md-3 mb-2">
                            <label for="late_fine">Late Fine</label>
                            <input type="text" class="form-control bg-dark" id="late_fine" name="late_fine" value="0"
                                onchange="calculateTotals()">
                        </div>
                        <div class="col-md-3 mb-2">
                            <label for="concession">Concession (If/Any)</label>
                            <select class="form-control bg-dark" id="concession" name="concession"
                                onchange="toggleConcessionFields()">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-2" id="con1" style="display: none;">
                            <label for="concession_amount">Concession Amount</label>
                            <input type="text" class="form-control bg-dark" id="concession_amount"
                                name="concession_amount" value="0" onchange="calculateTotals()">
                        </div>
                        <div class="col-md-3 mb-2" id="con2" style="display: none;">
                            <label for="concession_remarks">Concession Remarks</label>
                            <input type="text" class="form-control bg-dark" id="concession_remarks"
                                name="concession_remarks">
                        </div>
                        <div class="col-md-3 mb-2">
                            <label for="gross_amount">Total Amount Payable</label>
                            <input type="text" class="form-control bg-dark" id="gross_amount" name="gross_amount"
                                value="0" readonly>
                        </div>
                        <div class="col-md-3 mb-2">
                            <label for="paid_amount">Amount Paid</label>
                            <input type="text" class="form-control bg-dark" id="paid_amount" name="paid_amount"
                                value="0" onchange="calculateTotals()">
                        </div>
                        <div class="col-md-3 mb-2">
                            <label for="dues">Amount Dues</label>
                            <input type="text" class="form-control bg-dark" id="dues" name="dues" value="0" readonly>
                        </div>
                        <div class="col-md-3 mb-2">
                            <label for="payment_type">Payment Type</label>
                            <select class="form-control bg-dark" id="payment_type" name="payment_type"
                                onchange="toggleTransactionField()">
                                <option value="">--Select Payment Type--</option>
                                <option value="Cash">Cash</option>
                                <option value="Online">Online</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-2" id="trans" style="display: none;">
                            <label for="transaction_number">Transaction Number</label>
                            <input type="text" class="form-control" id="transaction_number" name="transaction_number">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mt-2 mb-2">
                            <button type="button" class="btn btn-primary w-100" id="BtnFee">Take Fee</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Update Fees Structure</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered" id="editFeeTable">
                        <thead class="thead-dark">
                            <tr class="bg-primary text-white">
                                <th>S.No.</th>
                                <th>Fee Name</th>
                                <th>Fee Amount</th>
                                <th>Month</th>
                                <th>Select Fee</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Editable fees will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveFeeChanges">Save changes</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Global variables
    let studentData = null;
    let feeData = null;
    let selectedMonths = [];
    let selectedFees = {}; // Format: { "FeeName_MonthValue": true/false }

    // Initialize on page load
    $(document).ready(function () {
        // Handle student ID input
        // Handle student ID input
        $('#txtsid').on('change', function () {
            const studentId = $(this).val().trim();
            if (!studentId) return;

            $.ajax({
                url: "{{ url_for('admin.generate_monthly_fee.generate_monthly_fee') }}",
                type: "POST",
                data: {
                    action: 'get_student',
                    student_id: studentId
                },
                success: function (response) {
                    if (response.success) {
                        studentData = response.student;
                        selectedMonths = [];
                        selectedFees = {};

                        // Update student info table
                        $('#studentInfoTable tbody').html(`
                    <tr>
                        <td>1</td>
                        <td>${studentData.Student_ID}</td>
                        <td>${studentData.Name}</td>
                        <td>${studentData.Class}</td>
                    </tr>
                `);

                        // Update previous dues
                        $('#previous_dues').val(response.previous_dues);

                        // Load month checkboxes
                        let monthHtml = '';
                        response.months.forEach(month => {
                            // Check if this month is already paid
                            const isPaid = response.paid_months.some(paidMonth => {
                                // Compare month text (e.g., "April 2023")
                                return paidMonth.includes(month.month_name) && paidMonth.includes(month.year);
                            });

                            monthHtml += `
                        <div class="form-check form-check-inline">
                            <input class="form-check-input month-checkbox" type="checkbox" 
                                id="month-${month.value}" 
                                value="${month.value}"
                                ${isPaid ? 'disabled' : ''}>
                            <label class="form-check-label ${isPaid ? 'text-muted' : ''}" 
                                for="month-${month.value}">
                                ${month.text}
                                ${isPaid ? '(Paid)' : ''}
                            </label>
                        </div>
                    `;
                        });
                        $('#monthCheckboxes').html(monthHtml).show();

                        // Show fee structure section
                        $('#feesstructure').show();
                    } else {
                        alert(response.message);
                    }
                },
                error: function () {
                    alert('Error fetching student data');
                }
            });
        });

        // Handle Generate Bill button
        $('#BtnSave').on('click', function () {
            selectedMonths = [];
            $('.month-checkbox:checked').each(function () {
                selectedMonths.push($(this).val());
            });

            if (selectedMonths.length === 0) {
                alert('Please select at least one month.');
                return;
            }

            if (!studentData) {
                alert('Please select a student first.');
                return;
            }

            $.ajax({
                url: "{{ url_for('admin.generate_monthly_fee.generate_monthly_fee') }}",
                type: "POST",
                data: {
                    action: 'calculate_fee',
                    selected_months: selectedMonths
                },
                success: function (response) {
                    if (response.success) {
                        feeData = response.fees;
                        selectedFees = {};

                        // Initialize all fees for all months as selected
                        feeData.forEach(fee => {
                            fee.MonthlyFees.forEach(month => {
                                month.fees.forEach(monthFee => {
                                    const key = `${monthFee.FeeName}_${month.value}`;
                                    selectedFees[key] = true;
                                });
                            });
                        });

                        // Update fee selection table
                        updateMainTable();

                        // Calculate totals
                        calculateTotals();
                    } else {
                        alert(response.message);
                    }
                },
                error: function () {
                    alert('Error calculating fees');
                }
            });
        });

        // Handle Edit button
        $('#btnOpenModal').on('click', function () {
            if (!feeData || !feeData.length) {
                alert('Please generate bill first');
                return;
            }

            let editHtml = '';
            let rowNum = 1;

            // Get the first fee entry (all have same MonthlyFees structure)
            const monthlyFees = feeData[0].MonthlyFees;

            // Group by month
            monthlyFees.forEach(month => {
                // Add month header row
                editHtml += `
                    <tr class="month-header">
                        <td colspan="5" class="text-center bg-dark text-white">
                            <strong>${month.month_name} ${month.year}</strong>
                        </td>
                    </tr>
                `;

                // Add fee rows for this month
                month.fees.forEach(fee => {
                    const key = `${fee.FeeName}_${month.value}`;
                    const isChecked = selectedFees[key] !== false;

                    editHtml += `
                        <tr>
                            <td>${rowNum++}</td>
                            <td>${fee.FeeName}</td>
                            <td>₹${parseFloat(fee.Fee).toFixed(2)}</td>
                            <td>${month.month_name} ${month.year}</td>
                            <td>
                                <input type="checkbox" class="form-check-input edit-fee-checkbox" 
                                    data-fee-name="${fee.FeeName}" 
                                    data-month-value="${month.value}"
                                    ${isChecked ? 'checked' : ''}>
                            </td>
                        </tr>
                    `;
                });
            });

            $('#editFeeTable tbody').html(editHtml);
            $('#editModal').modal('show');
        });

        // Handle Save Changes in modal
        $('#saveFeeChanges').on('click', function () {
            // Update selectedFees based on modal checkboxes
            $('.edit-fee-checkbox').each(function () {
                const feeName = $(this).data('fee-name');
                const monthValue = $(this).data('month-value');
                const key = `${feeName}_${monthValue}`;
                selectedFees[key] = $(this).is(':checked');
            });

            // Update the main table
            updateMainTable();

            // Recalculate totals
            calculateTotals();
            $('#editModal').modal('hide');
        });

        // Handle Take Fee button
        $('#BtnFee').on('click', function () {
            if (!studentData || !feeData) {
                alert('Please generate bill first');
                return;
            }

            // Validate form
            const concession = $('#concession').val();
            const concessionAmount = parseFloat($('#concession_amount').val()) || 0;
            const paidAmount = parseFloat($('#paid_amount').val()) || 0;
            const paymentType = $('#payment_type').val();
            const transactionNumber = $('#transaction_number').val();

            if (concession === 'Yes' && concessionAmount <= 0) {
                alert('Concession amount must be greater than 0');
                return;
            }

            if (concession === 'Yes' && concessionAmount > parseFloat($('#amount').val())) {
                alert('Concession amount cannot exceed total amount');
                return;
            }

            if (paidAmount <= 0) {
                alert('Paid amount must be greater than 0');
                return;
            }

            if (paymentType === 'Online' && !transactionNumber) {
                alert('Transaction number is required for online payments');
                return;
            }

            // Get selected fees and months
            const selectedFeeMonths = [];
            for (const key in selectedFees) {
                if (selectedFees[key]) {
                    const [feeName, monthValue] = key.split('_');
                    selectedFeeMonths.push({
                        feeName: feeName,
                        monthValue: monthValue
                    });
                }
            }

            if (selectedFeeMonths.length === 0) {
                alert('Please select at least one fee for at least one month');
                return;
            }

            // Prepare form data
            const formData = {
                action: 'submit_fee',
                amount: $('#amount').val(),
                previous_dues: $('#previous_dues').val(),
                late_fine: $('#late_fine').val(),
                concession: concession,
                concession_amount: concessionAmount,
                concession_remarks: $('#concession_remarks').val(),
                paid_amount: paidAmount,
                payment_type: paymentType,
                transaction_number: transactionNumber,
                selected_fee_months: JSON.stringify(selectedFeeMonths)
            };

            // Submit the form
            $.ajax({
                url: "{{ url_for('admin.generate_monthly_fee.generate_monthly_fee') }}",
                type: "POST",
                data: formData,
                success: function (response) {
                    if (response.success) {
                        window.location.href = response.redirect_url;
                    } else {
                        alert(response.message);
                    }
                },
                error: function () {
                    alert('Error submitting fee');
                }
            });
        });
    });

    // Update the main table based on selected fees
    function updateMainTable() {
        const feeGroups = {};

        // Group selected fees by fee name
        for (const key in selectedFees) {
            if (selectedFees[key]) {
                const [feeName, monthValue] = key.split('_');
                if (!feeGroups[feeName]) {
                    feeGroups[feeName] = {
                        months: [],
                        totalAmount: 0
                    };
                }

                // Find the original fee data to get the per-month amount
                const originalFee = feeData.find(f => f.FeeName === feeName);
                if (originalFee) {
                    const perMonthAmount = originalFee.PerMonthAmount;
                    feeGroups[feeName].totalAmount += perMonthAmount;

                    // Convert monthValue to display format (e.g., "05-2023" -> "May 2023")
                    const [monthNum, year] = monthValue.split('-');
                    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'];
                    const monthName = monthNames[parseInt(monthNum) - 1];
                    feeGroups[feeName].months.push(`${monthName} ${year}`);
                }
            }
        }

        // Update the main table
        let feeHtml = '';
        let index = 1;

        for (const feeName in feeGroups) {
            const feeInfo = feeGroups[feeName];

            feeHtml += `
                <tr>
                    <td>${index++}</td>
                    <td>${feeName}</td>
                    <td>${feeInfo.months.join(', ')}</td>
                    <td>₹${feeInfo.totalAmount.toFixed(2)}</td>
                    <td>
                        <input type="checkbox" class="form-check-input fee-checkbox" 
                            data-fee-name="${feeName}" 
                            onchange="updateFeeSelection(this)" checked>
                    </td>
                </tr>
            `;
        }

        $('#feeSelectionTable tbody').html(feeHtml);
    }

    // Update fee selection (called from checkbox onchange)
    function updateFeeSelection(checkbox) {
        const feeName = $(checkbox).data('fee-name');
        const isChecked = $(checkbox).is(':checked');

        // Update all month checkboxes for this fee
        for (const key in selectedFees) {
            if (key.startsWith(`${feeName}_`)) {
                selectedFees[key] = isChecked;
            }
        }

        // Update the main table
        updateMainTable();

        // Recalculate totals
        calculateTotals();
    }

    // Toggle concession fields
    function toggleConcessionFields() {
        const concession = $('#concession').val();
        $('#con1, #con2').toggle(concession === 'Yes');
        calculateTotals();
    }

    // Toggle transaction field
    function toggleTransactionField() {
        const paymentType = $('#payment_type').val();
        $('#trans').toggle(paymentType === 'Online');
    }

    // Calculate all totals
    function calculateTotals() {
        // Calculate base amount based on selected fees
        let baseAmount = 0;
        let selectedFeeNames = [];

        for (const key in selectedFees) {
            if (selectedFees[key]) {
                const [feeName, monthValue] = key.split('_');

                // Find the original fee data to get the per-month amount
                const originalFee = feeData.find(f => f.FeeName === feeName);
                if (originalFee) {
                    baseAmount += originalFee.PerMonthAmount;
                    if (!selectedFeeNames.includes(feeName)) {
                        selectedFeeNames.push(feeName);
                    }
                }
            }
        }

        // Update hidden input with selected fees
        $('#selectedFeesInput').val(selectedFeeNames.join(','));

        $('#amount').val(baseAmount.toFixed(2));

        // Get other values
        const previousDues = parseFloat($('#previous_dues').val()) || 0;
        const lateFine = parseFloat($('#late_fine').val()) || 0;
        const concession = $('#concession').val();
        const concessionAmount = concession === 'Yes' ? (parseFloat($('#concession_amount').val()) || 0) : 0;
        const paidAmount = parseFloat($('#paid_amount').val()) || 0;

        // Calculate gross amount
        let grossAmount = baseAmount + previousDues + lateFine;
        if (concession === 'Yes') {
            if (concessionAmount > grossAmount) {
                alert('Concession amount cannot exceed the Total Payable Amount!');
                $('#concession_amount').val('0');
                grossAmount = baseAmount + previousDues + lateFine;
            } else {
                grossAmount -= concessionAmount;
            }
        }

        $('#gross_amount').val(grossAmount.toFixed(2));

        // Calculate dues
        if (paidAmount > grossAmount) {
            alert('Paid amount cannot exceed the Total Payable Amount!');
            $('#paid_amount').val('0');
            $('#dues').val(grossAmount.toFixed(2));
        } else {
            const dues = grossAmount - paidAmount;
            $('#dues').val(dues.toFixed(2));
        }
    }
</script>
{% endblock %}