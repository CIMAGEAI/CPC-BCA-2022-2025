{% extends "Admin/AdminMaster.html" %}

{% block title %}Bus Management | Admin Panel{% endblock %}

{% block head %}
<style>
    .form-floating {
        margin-bottom: 1rem;
    }
    .table-responsive {
        overflow-x: auto;
    }
    .action-btn {
        margin: 0 5px;
    }
    .modal-content {
        background-color: #2b2b2b;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid pt-4 px-4">
    {% if error %}
        <div class="alert alert-danger alert-dismissible fade show">
            {{ error }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}
    {% if success %}
        <div class="alert alert-success alert-dismissible fade show">
            {{ success }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}

    <div class="row g-4">
        <div class="col-sm-12 col-xl-12">
            <div class="bg-secondary rounded h-100 p-4">
                <h6 class="mb-4">Add New Bus</h6>
                <form method="POST">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="bus_number" name="bus_number" 
                                       placeholder="Bus Number" required
                                       value="{{ bus_data.bus_number }}">
                                <label for="bus_number">Bus Number</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="registration_no" name="registration_no" 
                                       placeholder="Registration Number" required
                                       value="{{ bus_data.registration_no }}">
                                <label for="registration_no">Registration No.</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="stopage" name="stopage" 
                                       placeholder="Stopage" required
                                       value="{{ bus_data.stopage }}">
                                <label for="stopage">Stopage</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="number" class="form-control" id="fee" name="fee" 
                                       placeholder="Fee" required
                                       value="{{ bus_data.fee }}">
                                <label for="fee">Fee</label>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group mb-3">
                                <button type="submit" name="save" class="btn btn-primary">Save</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid pt-4 px-4">
    <div class="row g-4">
        <div class="col-sm-12 col-xl-12">
            <div class="bg-secondary rounded h-100 p-4">
                <h6 class="mb-4">Bus Details</h6>
                <div class="table-responsive">
                    {% if buses %}
                        <table class="table table-hover table-bordered custom-grid-bg">
                            <thead>
                                <tr class="bg-primary text-white">
                                    <th>Actions</th>
                                    <th>S.No.</th>
                                    <th>Bus No.</th>
                                    <th>Reg. No.</th>
                                    <th>Stopage</th>
                                    <th>Fee</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bus in buses %}
                                <tr>
                                    <td>
                                        <button class="btn btn-sm btn-info action-btn edit-btn" 
                                                data-id="{{ bus.id }}"
                                                data-bus-number="{{ bus.bus_number }}"
                                                data-registration-no="{{ bus.registration_no }}"
                                                data-stopage="{{ bus.stopage }}"
                                                data-fee="{{ bus.fee }}">
                                            Edit
                                        </button>
                                        <form method="POST" style="display: inline;">
                                            <input type="hidden" name="bus_id" value="{{ bus.id }}">
                                            <button type="submit" name="delete" class="btn btn-sm btn-danger action-btn"
                                                    onclick="return confirm('Are you sure you want to delete this bus?')">
                                                Delete
                                            </button>
                                        </form>
                                    </td>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ bus.bus_number }}</td>
                                    <td>{{ bus.registration_no }}</td>
                                    <td>{{ bus.stopage }}</td>
                                    <td>{{ bus.fee }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <h4 class="text-center text-danger">No buses found</h4>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit Bus Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST">
                <input type="hidden" id="edit_bus_id" name="bus_id">
                <div class="modal-body">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="edit_bus_number" name="updated_bus_number" required>
                        <label for="edit_bus_number">Bus Number</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="edit_registration_no" name="updated_registration_no" required>
                        <label for="edit_registration_no">Registration Number</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="edit_stopage" name="updated_stopage" required>
                        <label for="edit_stopage">Stopage</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="edit_fee" name="updated_fee" required>
                        <label for="edit_fee">Fee</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" name="update" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Handle edit button clicks
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('edit_bus_id').value = this.dataset.id;
            document.getElementById('edit_bus_number').value = this.dataset.busNumber;
            document.getElementById('edit_registration_no').value = this.dataset.registrationNo;
            document.getElementById('edit_stopage').value = this.dataset.stopage;
            document.getElementById('edit_fee').value = this.dataset.fee;
            
            // Show modal
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
        });
    });

    // Form validation
    document.querySelector('form').addEventListener('submit', function(e) {
        if (!document.getElementById('bus_number').value.trim()) {
            e.preventDefault();
            alert('Bus number is required');
        } else if (!document.getElementById('registration_no').value.trim()) {
            e.preventDefault();
            alert('Registration number is required');
        } else if (!document.getElementById('stopage').value.trim()) {
            e.preventDefault();
            alert('Stopage is required');
        } else if (!document.getElementById('fee').value.trim() || isNaN(document.getElementById('fee').value)) {
            e.preventDefault();
            alert('Valid fee is required');
        }
    });
</script>
{% endblock %}