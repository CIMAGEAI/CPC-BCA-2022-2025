{% extends "Admin/AdminMaster.html" %}

{% block title %}Create School | Admin Panel{% endblock %}

{% block content %}
<style>
    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .tooltip-inner {
        max-width: 300px;
    }
</style>

<div class="container-fluid pt-4 px-4">
    <div class="row g-4">
        <div class="col-sm-12 col-xl-12">
            <div class="bg-secondary rounded h-100 p-4">
                <h6 class="mb-4">Add School</h6>
                <form method="POST" enctype="multipart/form-data" id="schoolForm">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="name" name="name" placeholder="School Name" required>
                                <label for="name">School Name</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="mobile" name="mobile" placeholder="School Mobile" required pattern="[0-9]{10}" title="Please enter a 10-digit mobile number">
                                <label for="mobile">School Mobile</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <input type="email" class="form-control" id="email" name="email" placeholder="name@example.com" required>
                                <label for="email">School Email</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="afno" name="afno" placeholder="Affiliation Number" required>
                                <label for="afno">Affiliation Number</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="address" name="address" placeholder="School Address" required>
                                <label for="address">School Address</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label for="logo">School Logo (Max 2MB, PNG/JPG/JPEG/GIF)</label>
                                <input type="file" class="form-control bg-dark" id="logo" name="logo" accept="image/*">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group mb-3">
                                <button type="submit" class="btn btn-primary w-100" id="saveBtn">Save</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid pt-4 px-4">
    <div class="row g-4">
        <div class="col-sm-12 col-xl-12">
            <div class="bg-secondary rounded h-100 p-4">
                <h6 class="mb-4">School Details</h6>
                <div class="row">
                    <div class="col-12">
                        <div class="table-responsive">
                            {% if not schools %}
                                <h4 class="text-center text-danger">No Schools Found</h4>
                            {% else %}
                             <table class="table table-hover table-bordered custom-grid-bg">
                                    <thead>
                                        <tr class="bg-primary text-white">
                                            <th>Action</th>
                                            <th>S.No.</th>
                                            <th>School Name</th>
                                            <th>Mobile</th>
                                            <th>Email</th>
                                            <th>Affiliation No.</th>
                                            <th>Address</th>
                                            <th>Image</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for school in schools %}
                                        <tr>
                                            <td>
                                                <button class="btn btn-sm btn-info edit-btn" 
                                                    data-id="{{ school['Id'] }}"
                                                    data-name="{{ school['Name'] }}"
                                                    data-mobile="{{ school['Mobile'] }}"
                                                    data-email="{{ school['Email'] }}"
                                                    data-afno="{{ school['Affiliation_Number'] }}"
                                                    data-address="{{ school['Address'] }}">
                                                    Edit
                                                </button>
                                                <form method="POST" action="{{ url_for('admin.create_school.delete_school', school_id=school['Id']) }}" style="display:inline;">
                                                    <button type="submit" class="btn btn-sm btn-danger delete-btn"
                                                        onclick="return confirm('Are you sure you want to delete this school?')">
                                                        Delete
                                                    </button>
                                                </form>
                                            </td>
                                            <td>{{ loop.index }}</td>
                                            <td>{{ school['Name'] }}</td>
                                            <td>{{ school['Mobile'] }}</td>
                                            <td>{{ school['Email'] }}</td>
                                            <td>{{ school['Affiliation_Number'] }}</td>
                                            <td>{{ school['Address'] }}</td>
                                            <td>
                                                {% if school['Image'] %}
                                                <img src="{{ url_for('static', filename='AdminAssets/Image/' + school['Image']) }}" 
                                                     alt="School Logo" style="max-width: 100px; max-height: 50px;">
                                                {% else %}
                                                No Image
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-secondary">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit School</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editForm" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="hidden" id="edit_id" name="school_id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="edit_name" name="name" placeholder="School Name" required>
                                <label for="edit_name">School Name</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="edit_mobile" name="mobile" placeholder="School Mobile" required pattern="[0-9]{10}" title="Please enter a 10-digit mobile number">
                                <label for="edit_mobile">School Mobile</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="email" class="form-control" id="edit_email" name="email" placeholder="name@example.com" required>
                                <label for="edit_email">School Email</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="edit_afno" name="afno" placeholder="Affiliation Number" required>
                                <label for="edit_afno">Affiliation Number</label>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="edit_address" name="address" placeholder="School Address" required>
                                <label for="edit_address">School Address</label>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group mb-3">
                                <label for="edit_logo">Update School Logo (Leave empty to keep current)</label>
                                <input type="file" class="form-control bg-dark" id="edit_logo" name="logo" accept="image/*">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltip
        const saveBtn = document.getElementById('saveBtn');
        const tooltip = new bootstrap.Tooltip(saveBtn);
        
        // Check if school exists and disable save button
        const schoolsExist = {{ 'true' if schools else 'false' }};
        if (schoolsExist) {
            saveBtn.disabled = true;
            saveBtn.title = "Only one school can be created. Delete existing school to create a new one.";
            tooltip.update();
        }

        // Edit button functionality
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', function() {
                const form = document.getElementById('editForm');
                form.action = "{{ url_for('admin.create_school.update_school', school_id=0) }}".replace('0', this.dataset.id);

                document.getElementById('edit_id').value = this.dataset.id;
                document.getElementById('edit_name').value = this.dataset.name;
                document.getElementById('edit_mobile').value = this.dataset.mobile;
                document.getElementById('edit_email').value = this.dataset.email;
                document.getElementById('edit_afno').value = this.dataset.afno;
                document.getElementById('edit_address').value = this.dataset.address;

                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
            });
        });

        // Form submission prevention if school exists
        document.getElementById('schoolForm').addEventListener('submit', function(e) {
            if ({{ 'true' if schools else 'false' }}) {
                e.preventDefault();
                alert('Only one school can be created. Delete existing school to create a new one.');
                return false;
            }
        });
    });
</script>

<!-- Flash messages -->
<script>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                alert("{{ message }}");
            {% endfor %}
        {% endif %}
    {% endwith %}
</script>
{% endblock %} 